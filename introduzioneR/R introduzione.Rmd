---
title: "R e l'analisi dei dati: una gentile introduzione"
author: "Gaetano Scaduto"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduzione a R per l'analisi dati

Questo documento è pensato per chi non è riuscito per problemi tecnici ad installare R nel proprio pc o si è perso qualcosa durante la lezione. I contenuti principali che verranno trattati a lezione sono anche qui, anche se quello che faremo in classe potrebbe essere più approfondito. Le porzioni di testo che vedrete dentro i box sono dei codici che potete tranquillamente copiare e incollare su RStudio, ma sono uguali a quelli che trovate nello script caricato insieme a questo file. Iniziamo.

## Perché imparare R?

La prima domanda che potreste farvi è: perché dovrei voler imparare R? Qui una serie di ragioni per cui secondo me può valer la pena.

-   E' molto richiesto ed apprezzato nel mercato del lavoro.

-   Imparare R vi libera sostanzialmente dalla necessità di imparare qualunque altro software statistico

-   Al contrario di tutti gli altri, è **gratis**

-   Vi potrà facilitare in tutta una serie di compiti che ancora non sapete nemmeno di dover affrontare nella vostra vita professionale.

Quali sono i contro di usare R?

-   All'inizio, è **difficile da imparare**, soprattutto se non avete mai programmato prima. Bisogna essere pazienti e non arrabbiarsi, piano piano ce la si fa.

-   Nella vostra vita professionale potreste far parte di una minoranza, e dovete esser pronti ad essere un po' dei lupi solitari

    -   In azienda si usa di più **Tableau, SPSS o Python**

    -   In università si usa di più **Stata**

    -   Nel pubblico si usa di più **Excel/SPSS**

-   Forse verremmo tutti spazzati via da ChatGTP, boh

Questa lezione è solo un assaggino. Purtroppo in Bicocca che io sappia non abbiamo (per ora!) un corso di R. Un consiglio che vi posso dare per chi avesse voglia è seguire [questo libro qu CLICCA QUI](https://r4ds.hadley.nz/). Se vi imparate questo libro (che è fatto super bene ed è **gratis e disponibile online**, come tutto quello che viene fatto dalla splendida commuity di R) non vi ferma nessuno. Ed è molto facile da studiare da soli. Iniziamo!

# Primissimi passi

R si basa su una filosofia open source. Alcune cose le avete "comprese nel pacchetto base", altre cose le scaricate da un archivio online. Si tratta di "pacchetti" che vi permettono di espandere le funzionalità base di R. Prima di utilizzare un pacchetto per la prima volta, **solo per la prima volta**, dovete installarlo. Per installarlo vi serve una connessione ad internet ed eseguire i comandi di seguito. Noi per questa lezione useremo tre pacchetti **rio**, **ggplot2 e texreg**

```{r, eval=FALSE}
install.packages("rio")
install.packages("ggplot2")
install.packages("texreg")
```

Dopo aver installato, dovete chiamare la libreria. Questo va fatto **ogni volta che riaccendete R** con il comando **library**

```{r, warning = F}

library(rio)
library(ggplot2)
library(texreg)
```

Un ultima finezza. Voglio i numeri con la virgola, non la notazione scientifica. Per farlo, dico a r questa cosa.

```{r, warning = F}
options(scipen = 999)
```

# Importare un file

La libreria rio (che sta per R Input/Output) vi permette di importare file su R senza sbatti. Nel nostro caso io vi ho preparato un dataset coi **risultati delle elezioni del 2022 su tutti i comuni italiani** più qualche altra info. Questo dataset è basato sugli open data del ministero degli interni che sono stati da me manipolati un po' e uniti con un tot di statistiche dell'Istat. Per importarlo in R dovete fare le seguenti cose:

-   Create una cartella da qualche parte nel vostro computer e dategli un nome

-   In quella cartella, metteteci il dataset che vi abbiamo caricato online. Potete anche solo copiarlo e incollarlo all'interno di quella cartella.

Dopodiché dovrete dire ad R che state lavorando in quella cartella. Per farlo, dovrete eseguire il comando "setwd()" (che sta per "set working directory") e mettere, tra virgolette, il percorso della cartella.

-   Per trovare il percorso della cartella, se avete windows basta fare tasto destro sulla cartella e poi "copia come percorso"

-   ![](Screenshot%202023-10-05%20085155.png){width="323"}

-   Se avete Mac cercate su google "come copiare percorso cartella Mac", ma secondo me potete vedere da "proprietà" col tasto destro o qualcosa del genere. Io ho provato a cercare su google ma mica l'ho capito.

    -   Se proprio non riuscite: uscite da R e **cliccate sul file del dataset due volte**. Se intendete imparare come si usa R questa cosa non va bene, ma per sta volta passi...

-   **Attenzione! Se lo fate su windows, quello che vi copierà sarà così**

-   "C:\\Users\\gasca\\OneDrive - Università degli Studi di Milano-Bicocca\\Desktop\\cartella esempio"

-   R per uno strano motivo vuole che le stanghette non siano \\ ma /, quindi voi dovrete cambiarle manualmente così

-   C:/Users/gasca/OneDrive - Università degli Studi di Milano-Bicocca/Desktop/cartella esempio

Quindi il comando sarà

```{r, eval = FALSE}

setwd("C:/Users/gasca/OneDrive - Università degli Studi di Milano-Bicocca/Desktop/cartella esempio")
```

Una volta fatto ciò, eseguite il seguente comando (non dimenticate le virgolette ""!)

```{r, warning = F}
data = import("ris2022_lezione.RDS")
```

-   NOTA: se avete fatto doppioclic sul dataset dalla cartella (per quelli che non trovavano come copiare il percorso della cartella), il comando di sopra non eseguitelo!

In questo caso state dicendo ad R: prendi l'oggetto chiamato nel modo dentro le virgolette (dalla cartella che gli abbiamo detto prima), importamelo su R e chiamalo, da ora in poi "data". "data" è il nome con cui chiameremo i nostri dati. Notate che dovrete sempre riportare il nome del file che volete importare **compreso di estensione.** Con la funzione import() (che fa parte di rio) potete importare senza problemi sostanzialmente qualunque tipo di data file esistente. Anche un foglio excel.

Nota: questo dataset ha qualche dato mancante. Per semplicità noi lavoreremo coi dati completi. Rimuovo quindi tutte le righe che hanno "missing data" con questo comando

```{r, warning = F}
data = data[complete.cases(data), ]
```

# Sbirciamo nei dati

Adesso vogliamo sbirciare nei dati. Possiamo farlo col comando head()

```{r, warning = F}
head(data)
```

Se volessimo vedere ancora meglio nei dati, su R fate partire il comando "View(data)" e potete navigare in libertà nel dataset.

Se vogliamo velocemente un sommario di quello che contine il dataset, possiamo eseguire il seguente comando

```{r, warning = F}
summary(data)
```

Adesso andiamo a vedere qualche statistica nello specifico. Per fare così, dovremo "chiamare" direttamente le colonne del dataset. Per farlo si usa l'operatore \$ dopo il nome del dataset. Rstudio vi suggerirà poi lui stesso i nomi delle colonne disponibili di modo che possiate accedere a queste. Calcoliamoci qualche statistica di base come esempio. Tipo la media del numero di residenti nei comuni del nostro dataset

```{r, warning = F}
mean(data$num_residenti)
```

Oppure la mediana

```{r, warning = F}
median(data$num_residenti)
```

Oppure ci chiediamo: "ma nel comune dove il movimento 5 stelle ha preso la percentuale più alta, ma quanto ha preso?". La risposta è data da questo comando.

```{r, warning = F}
max(data$M5S)
```

Se invece ci chiedessimo quanto è piccolo il più piccolo comune che abbiamo nel dataset...

```{r, warning = F}
min(data$superficie)
```

Adesso ci chiediamo se, per esempio, la media del numero di voti presi da Forza Italia nei comuni della Calabria è diversa da quella dei comuni in Umbria

```{r, warning = F}
mean(data[data$regione == "Calabria", ]$Fi)

mean(data[data$regione == "Umbria", ]$Fi)
```

# Le tabelle

Adesso vedremo un po' di tabelle. Le tabelle possono essere molto utili per capire come si distribuiscono i nostri dati. Possiamo fare tabelle con una variabile sola o con due variabili, ed in entrambi i casi si usa il comando "table". Vediamo ad esempio come è distribuita la variabile areeint (codice aree interne istat - indica la perifericità del comune: A è un comune centrale, F è un comune sperduto).

```{r, warning = F}
table(data$areeint)
```

Se vogliamo creare una tabella di due variabili incrociate, allora basta metterle in table separate da una virgola.

```{r, warning = F}
table(data$macroarea, data$areeint)

```

Questa tabella non è molto informativa, possiamo pensare a fare una tabella con le proporzioni con il seguente comando.

```{r, warning = F}
prop.table(table(data$macroarea, data$areeint))
```

Non si capisce niente! Troppe cifre decimali! Risolviamo con la funzione "round" dicendogli di arrotondare a due cifre soltanto.

```{r, warning = F}
round(prop.table(table(data$macroarea, data$areeint)), digits = 2)
```

Queste sono le percentuali su tutta la tabella. Forse sarebbe più utile averle per riga o per colonna. Per fare così dobbiamo aggiungere a prop.table un'opzione. 1 corrisponde alle percentuali per riga. 2 alle percentuali per colonna.

```{r, warning = F}
round(prop.table(table(data$macroarea, data$areeint), 1), digits = 2)

```

```{r, warning = F}
round(prop.table(table(data$macroarea, data$areeint), 2), digits = 2)

```

# Grafici

Per i grafici noi usiamo la libreria ggplot2. Secondo me è il modo migliore. Ggplot2 ha un linguaggio un po' criptico. Limitatevi per adesso a copia-incollare i comandi. Per i più audaci in assoluto, gli stessi che hanno scritto il libro su R hanno anche scritto il libro su ggplot2 ([QUI](https://ggplot2-book.org/)) Anche qui, per capire ci vuole tanta pazienza, ma basta cogliere l'idea per adesso. Ad esempio, proviamo a vedere come sono distribuiti i voti al PD.

```{r, warning = F}
ggplot(data, aes(x=PD))+
 geom_density()
```

Proviamo a fare un **diagramma a barre** (barplot) sul partito più votato in tutti i comuni

```{r, warning = F}
ggplot(data, aes(x=most_voted))+
  geom_bar()
```

Se le volessi colorate queste barre, scriverei così

```{r, warning = F}
ggplot(data, aes(x=most_voted))+
  geom_bar(aes(fill=most_voted))
```

Vogliamo provare a vedere se c'è una correlazione fra il numero di abitanti in un comune ed il fatto che il pd sia il partito più votato. Proviamo con geom_point()

```{r, warning = F}
ggplot(data, aes(x=PD, y=num_residenti))+
  geom_point()
```

Così non si capisce molto. Posso provare a prendere il logaritmo della variabile numero di residenti.

```{r, warning = F}
ggplot(data, aes(x=PD, y=log(num_residenti)))+
  geom_point()

```

Già meglio! Ma se volessi provare a vedere una retta di regressione lì in mezzo?

```{r, warning = F}
ggplot(data, aes(x=PD, y=log(num_residenti)))+
  geom_point(alpha=1/10)+
  geom_smooth(method="lm")
```

Carino!

# La regressione!

Finiamo la nostra carrellata con qualche regressione. Qui faremo solo regressioni lineari. Supponiamo di voler provare a costruire un modello che spiega il voto al movimento cinque stelle. Facciamo quindi una serie di regressioni lineari, che si fanno col comando "lm". Il primo argomento di "lm" è "data=nomemiodataset" (nel nostro caso sfortunato il nostro dataset si chiama proprio data). Poi mettete la variabile dipendente, una tilde \~ (Alt+126) e poi le variabili indipendenti. Salvate tutto il risultato in un oggetto e osservate i risultati della vostra regressione mettendo l'oggetto in una funzione screenreg(). Partiamo da un modello celeberrimo: "i cinque stelle partito del sud"

```{r, warning = F}
regr1 = lm(data=data, M5S ~ macroarea)
screenreg(regr1)
```

Domandina: qual è la categoria di riferimento?

Adesso proviamo un modello più sofisticato, che tiene anche in conto la perifericità

```{r, warning = F}
regr2 = lm(data=data, M5S ~ macroarea + areeint)
screenreg(regr2)
```

Infine, proviamo anche a metterci dentro il numero di residenti, che è una variabile continua, e la superficie del comune, che è anch'essa una variabile continua.

```{r, warning = F}
regr3 = lm(data=data, M5S ~ macroarea + areeint + num_residenti + superficie)
screenreg(regr3)
```

Qui termina la nostra lezione. Di nuovo: non vi spaventate. R è difficile. Adesso sapete che esiste. Se un domani vorrete (o dovrete) impararlo il mio consiglio è di essere pazienti e non arrabbiarvi. Dopo un po' ce la si fa e ne vale la pena.

Per qualunque cosa non esitate a scrivermi a **g.scaduto2\@campus.unimib.it**

Ciao!

![](FFgtGkKWUAIspUI.jpg){width="353"}

![](ghKLs78.jpg){width="402"}

![](John_Mclarty.png){width="444"}

PS: questo intero documento è stato scritto su RStudio.
